{% if section.settings.timer %}
  {% assign is_there_a_img_block = false %}
  {%- if section.blocks.size > 0 -%}
    {% for block in section.blocks %}
      {% if block.type == 'image' %}
        {% assign is_there_a_img_block = true %}
      {% endif %}
    {% endfor %}
  {%- else -%}
    {% assign is_there_a_img_block = false %}
  {%- endif -%}

  {%- liquid
    assign desktop_image = section.settings.desktop_image
    assign mobile_image = section.settings.mobile_image
    assign image_opacity = section.settings.image_opacity | divided_by: 100.0
    assign image_size = section.settings.image_size
  -%}

  <style>
    {% if is_there_a_img_block ==  false %}
    @media screen and (max-width: 767px){
        #{{ section.id }}{
            height: {{ section.settings.mobile_section_height }}px !important;
        }
    }
    {% endif %}

    .countdown-timer--layout.with-image .countdown-timer--image-block {
      z-index: 1;
    }

    #{{ section.id }} .countdown-timer--bg-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: {{ image_size }};
        opacity: {{ image_opacity }};
        z-index: 1;
    }

    #{{ section.id }} .countdown-timer--bg-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        {% if section.settings.bg_color_par != blank %}
            background: {{ section.settings.bg_color_par }};
        {% else %}
            background: #000;
        {% endif %}
        z-index: 0;
    }

    #{{ section.id }} .countdown-timer--container {
        position: relative;
        z-index: 2;
    }

    #{{ section.id }} .countdown-timer--container.block-image{
        display: flex;
        width: 100%;
        margin: 0 auto;
        align-items: center;
        height: 100%;
        flex-direction: column;
        justify-content: center;
    }

    .empty_space_hr {
      color: transparent;
      line-height: 4em;
    }

    .countdown-timer--content {
      padding-left: 50px;
    }

    .empty_space_hr:after {
      content: "";
      display: flex;
      height: 1px;
      background: #ffffff3d;
      width: 100%;
      position: absolute;
    }

    @media screen and (max-width: 767px) {
        #{{ section.id }} .countdown-timer--bg-image.desktop-only {
            display: none;
        }

        #{{ section.id }} .countdown-timer--bg-image.mobile-only {
            display: block;
        }
    }

    @media screen and (min-width: 768px) {
        #{{ section.id }} .countdown-timer--bg-image.desktop-only {
            display: block;
        }

        #{{ section.id }} .countdown-timer--bg-image.mobile-only {
            display: none;
        }
    }
  </style>

  <div
    id="{{ section.id }}"
    class="countdown-timer--wrapper"
    style="{% if section.settings.bg_color_par != blank %}background: {{ section.settings.bg_color_par }} !important;{% endif %} {% if is_there_a_img_block ==  false %} height: {{ section.settings.section_height }}px;  {% endif %} position: relative; overflow: hidden;"
  >
    <!-- Background overlay (color) -->
    <div class="countdown-timer--bg-overlay"></div>

    <!-- Desktop background image -->
    {% if desktop_image %}
      <img
        src="{{ desktop_image | image_url: width: 1920 }}"
        alt=""
        class="countdown-timer--bg-image desktop-only"
        loading="lazy"
        sizes="100vw"
        srcset="
          {%- if desktop_image.width >= 375 -%}{{ desktop_image | image_url: width: 375 }} 375w,{%- endif -%}
          {%- if desktop_image.width >= 750 -%}{{ desktop_image | image_url: width: 750 }} 750w,{%- endif -%}
          {%- if desktop_image.width >= 1100 -%}{{ desktop_image | image_url: width: 1100 }} 1100w,{%- endif -%}
          {%- if desktop_image.width >= 1500 -%}{{ desktop_image | image_url: width: 1500 }} 1500w,{%- endif -%}
          {%- if desktop_image.width >= 1780 -%}{{ desktop_image | image_url: width: 1780 }} 1780w,{%- endif -%}
          {%- if desktop_image.width >= 2000 -%}{{ desktop_image | image_url: width: 2000 }} 2000w,{%- endif -%}
          {%- if desktop_image.width >= 3000 -%}{{ desktop_image | image_url: width: 3000 }} 3000w,{%- endif -%}
          {{ desktop_image | image_url }} {{ desktop_image.width }}w
        "
        width="{{ desktop_image.width }}"
        height="{{ desktop_image.height }}"
      >
    {% endif %}

    <!-- Mobile background image -->
    {% if mobile_image %}
      <img
        src="{{ mobile_image | image_url: width: 750 }}"
        alt=""
        class="countdown-timer--bg-image mobile-only"
        loading="lazy"
        sizes="100vw"
        srcset="
          {%- if mobile_image.width >= 375 -%}{{ mobile_image | image_url: width: 375 }} 375w,{%- endif -%}
          {%- if mobile_image.width >= 550 -%}{{ mobile_image | image_url: width: 550 }} 550w,{%- endif -%}
          {%- if mobile_image.width >= 750 -%}{{ mobile_image | image_url: width: 750 }} 750w,{%- endif -%}
          {%- if mobile_image.width >= 1100 -%}{{ mobile_image | image_url: width: 1100 }} 1100w,{%- endif -%}
          {{ mobile_image | image_url }} {{ mobile_image.width }}w
        "
        width="{{ mobile_image.width }}"
        height="{{ mobile_image.height }}"
      >
    {% endif %}

    {%- if section.blocks.size > 0 -%}
      <div class="countdown-timer--layout with-image">
        <div class="countdown-timer--image-block">
          {% for block in section.blocks %}
            {% if block.type == 'image' %}
              {% if block.settings.image != blank %}
                <img
                  src="{{ block.settings.image | image_url: width: 800 }}"
                  alt="{{ block.settings.image.alt | escape }}"
                  loading="lazy"
                  class="countdown-timer--side-image"
                  width= "100%"
                  height= "auto">
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
        <div class="countdown-timer--content">
          <!-- Aquí va TODO tu contenido actual -->

          <div class="countdown-timer--container block-image">
            <div class="countdown-timer--info-title">
              <h3 class="countdown-title">{{ section.settings.first_text }}</h3>
              <span class="below-text-countdown">{{ section.settings.second_text }}</span>
            </div>
            <div class="countdown-timer--date-text">
              <span>{{ section.settings.third_text }}</span>
            </div>
            <div class="empty_space_hr">space</div>
            <div class="countdown-timer">-D --:--:--</div>
            <div class="empty_space_hr">space</div>
            <a href="{{ section.settings.url }}" class="countdown-timer--button button"> See it now </a>
          </div>
        </div>
      </div>
    {%- else -%}
      <!-- Layout sin imagen, dejas lo que ya tenías -->
      <a href="{{ section.settings.url }}" class="countdown-timer--url">
        <div class="countdown-timer--container">
          <div class="countdown-timer--left">
            <span class="below-text-countdown">{{ section.settings.first_text }}</span>
            <h3 class="countdown-title">{{ section.settings.second_text }}</h3>
          </div>
          <div class="countdown-timer--right">
            <span>{{ section.settings.third_text }}</span>
            <div class="countdown-timer">-D --:--:--</div>
          </div>
        </div>
      </a>
    {%- endif -%}
  </div>

  <script>
    (function () {
      // Obtenemos el ID de la sección actual
      var sectionId = '{{ section.id }}';
      var wrapper = document.getElementById(sectionId);
      if (!wrapper) return;

      var countdown_timer = '{{ section.settings.timer }}';
      if (!countdown_timer) return;

      // Parseamos la fecha: formato MM/DD/YYYY HH:mm
      var parts = countdown_timer.split(' ');
      var dateParts = parts[0].split('/');
      var timeParts = parts[1].split(':');

      var targetDate = new Date(
        dateParts[2], // YYYY
        dateParts[0] - 1, // MM (0-based)
        dateParts[1], // DD
        timeParts[0], // HH
        timeParts[1] || 0 // mm
      );

      if (isNaN(targetDate.getTime())) return;

      var display = wrapper.querySelector('.countdown-timer');

      function updateCountdown() {
        var now = new Date().getTime();
        var distance = targetDate.getTime() - now;

        if (distance <= 0) {
          wrapper.style.display = 'none';
          clearInterval(timerInterval);
          return;
        }

        // Cálculos estándar (W3Schools style)
        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // Renderizamos en el HTML
        display.innerHTML =
          '<div class="div1">' +
          (days < 10 ? '0' : '') +
          days +
          '</div>' +
          '<div class="div2"><span>Days</span></div> ' +
          '<div class="div3">' +
          (hours < 10 ? '0' : '') +
          hours +
          '</div>' +
          '<div class="div4"><span>Hours</span></div>' +
          '<div class="div5">' +
          (minutes < 10 ? '0' : '') +
          minutes +
          '</div>' +
          '<div class="div6"><span>Min</span></div>' +
          '<div class="div7">' +
          (seconds < 10 ? '0' : '') +
          seconds +
          '</div>' +
          '<div class="div8"><span>Sec</span></div>';
      }

      // Ejecuta ahora mismo y luego cada 1s
      updateCountdown();
      var timerInterval = setInterval(updateCountdown, 1000);
    })();
  </script>
{% endif %}

{% stylesheet %}

    .countdown-timer--wrapper {
        background: #000;
        padding: 30px 50px;
    }
    a.countdown-timer--url {
        text-decoration: none;
    }
    .countdown-timer--container {
        max-width: var(--page-width);
        margin: 0 auto;
        display: flex;
        color: #fff;
        padding: 5px 3em;
        align-items: center;
        height: 100%;
    }
    .countdown-timer--container>div {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .countdown-timer--right {
        text-align: right;
    }
    .countdown-timer--container>div span {
        font-size: 16px;
        text-transform: uppercase;
        color: #eee;
        line-height: 18px;
    }
    .countdown-timer--container .countdown-title {
        font-size: 3em;
        text-transform: uppercase;
        line-height: 1.3em;
        color: #fff;
        font-weight: 700;
        text-align: center;
    }
    .countdown-timer {
        display: flex;
        font-size: 24px;
        text-transform: uppercase;
        line-height: 28px;
        color: #fff;
        font-weight: 800;
    }

    .countdown-timer--container.block-image .countdown-timer {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(2, 1fr);
        font-size: 4.5em;
        text-transform: uppercase;
        line-height: 5px;
        color: #fff;
        font-weight: 600;
        justify-content: center;
        justify-items: center;
        row-gap: 5px;
        column-gap: 30px;
    }

      .countdown-timer--container.block-image .countdown-timer .div1 { grid-area: 1 / 1 / 2 / 2; }
      .countdown-timer--container.block-image .countdown-timer .div2 { grid-area: 2 / 1 / 3 / 2; }
      .countdown-timer--container.block-image .countdown-timer .div3 { grid-area: 1 / 2 / 2 / 3; }
      .countdown-timer--container.block-image .countdown-timer .div4 { grid-area: 2 / 2 / 3 / 3; }
      .countdown-timer--container.block-image .countdown-timer .div5 { grid-area: 1 / 3 / 2 / 4; }
      .countdown-timer--container.block-image .countdown-timer .div6 { grid-area: 2 / 3 / 3 / 4; }
      .countdown-timer--container.block-image .countdown-timer .div7 { grid-area: 1 / 4 / 2 / 5; }
      .countdown-timer--container.block-image .countdown-timer .div8 { grid-area: 2 / 4 / 3 / 5; }


      /* Cuando hay bloque de imagen */
      .countdown-timer--layout {
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
      }

      .countdown-timer--layout.with-image .countdown-timer--image-block,
      .countdown-timer--layout.with-image .countdown-timer--content {
        flex: 1 1 50%;
        width: 50%;
      }

      /* Imagen lateral */
      .countdown-timer--side-image {
        width: 100%;
        height: auto;
        display: block;
      }


      .countdown-timer > div {
        min-width: 100px;
        min-height: fit-content;
        white-space: nowrap;
        text-align: center;
      }

      @media screen and (min-width: 1000px) and (max-width: 1200px) {

        .countdown-timer--container .countdown-title {
            font-size: 2.3em;
        }

        .countdown-timer--container.block-image .countdown-timer{
          font-size: 2.3em;
        }


      }

      @media screen and (min-width: 768px) and (max-width: 999px) {

        .countdown-timer--container .countdown-title {
            font-size: 1.3em;
        }

        .countdown-timer--container.block-image .countdown-timer{
          font-size: 1.3em;
          column-gap: 10px;
        }

        .countdown-timer > div {
          min-width: 30px;
        }

      }

      /* Responsive: en móviles siempre columna */
      @media screen and (max-width: 767px){

          .countdown-timer > div {
            min-width: 30px;
          }

          .countdown-timer--container>div {
              align-items: center;
          }

          .countdown-timer--container {
              padding: 0;
              flex-direction: column;
          }
          .countdown-timer--container>div span {
              font-size: 14px;
              line-height: 16px;
          }
          .countdown-timer--container .countdown-title {
              font-size: 2em;
              line-height: 32px;
              margin: 0;
          }

          .countdown-timer--container.block-image .countdown-timer{
            font-size: 2.5em;
          }

          .countdown-timer--layout.with-image {
            flex-direction: column;
          }


          .countdown-timer--layout.with-image .countdown-timer--image-block,
          .countdown-timer--layout.with-image .countdown-timer--content {
            flex: 1 1 100%;
          }

          .countdown-timer--layout.with-image .countdown-timer--image-block{
            width: 70%;
          }

          .countdown-timer--layout.with-image .countdown-timer--content{
            width: 100%;
            padding-left: 0px;
          }
      }
{% endstylesheet %}

{% schema %}
{
  "name": "Countdown Timer Banner",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "Background settings"
    },
    {
      "type": "color_background",
      "id": "bg_color_par",
      "label": "Background Color",
      "info": "Used as overlay or fallback when no image is selected"
    },
    {
      "type": "image_picker",
      "id": "desktop_image",
      "label": "Desktop background image"
    },
    {
      "type": "image_picker",
      "id": "mobile_image",
      "label": "Mobile background image"
    },
    {
      "type": "range",
      "id": "image_opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "Image opacity",
      "default": 70
    },
    {
      "type": "select",
      "id": "image_size",
      "options": [
        {
          "value": "cover",
          "label": "Cover"
        },
        {
          "value": "contain",
          "label": "Contain"
        },
        {
          "value": "fill",
          "label": "Fill"
        }
      ],
      "default": "cover",
      "label": "Image size",
      "info": "Cover: Image fills entire area (may crop). Contain: Image fits within area. Fill: Image stretches to fill area."
    },
    {
      "type": "header",
      "content": "Section height"
    },
    {
      "type": "number",
      "id": "section_height",
      "label": "Desktop height (px)",
      "default": 400
    },
    {
      "type": "number",
      "id": "mobile_section_height",
      "label": "Mobile height (px)",
      "default": 400
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "richtext",
      "id": "first_text",
      "label": "First Text"
    },
    {
      "type": "richtext",
      "id": "second_text",
      "label": "Second Text"
    },
    {
      "type": "richtext",
      "id": "third_text",
      "label": "Third Text"
    },
    {
      "type": "url",
      "id": "url",
      "label": "URL"
    },
    {
      "type": "text",
      "id": "timer",
      "label": "Date and time to countdown",
      "info": "please use this format: MM/DD/YYYY HH:mm Example: 08/28/2025 9:00",
      "placeholder": "MM/DD/YYYY HH:mm"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image block Countdown",
      "limit": 1,
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Imagen lateral"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Countdown Timer Banner",
      "category": "Banners"
    }
  ]
}
{% endschema %}
